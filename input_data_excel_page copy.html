<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Code Label Print</title>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@12.1.2/dist/handsontable.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/handsontable@12.1.2/dist/handsontable.full.min.css"
    />
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f8f9fa;
        text-align: center;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
      }

      .handsontable-container {
        border: 1px solid #ccc;
        margin-bottom: 15px;
        padding: 5px;
        background: white;
        border-radius: 5px;
      }

      .label-container {
        width: 4cm;
        height: 4cm;
        background: white;
        padding: 2px;
        border: 1px solid black;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        margin: auto;
        text-align: left;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }

      .data-table {
        width: 60%;
        font-size: 5px;
        line-height: 1;
        text-align: left;
        margin-left: 2px;
      }

      .data-table td {
        padding: 1px;
      }

      .data-table td:first-child {
        font-weight: bold;
        width: 40%;
      }

      #qrcode {
        width: 35%;
        margin-left: -10px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .print-button {
        display: block;
        margin: 10px auto;
        padding: 8px 15px;
        font-size: 14px;
        background: black;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }

      .print-button:hover {
        background: #333;
      }

      @media print {
        .print-button,
        .handsontable-container,
        h2 {
          display: none;
        }
        body {
          background: white;
        }
        .container {
          box-shadow: none;
          padding: 5px;
        }
        .label-container {
          width: 4cm;
          height: 4cm;
          border: none;
          box-shadow: none;
          font-size: 4px;
        }
      }
    </style>
    <a href="index.html"><h1>HOME</h1></a>
  </head>
  <body>
    <div class="container">
      <h2>Enter Data for QR Code</h2>
      <div class="handsontable-container">
        <div id="handsontable"></div>
      </div>

      <h2>QR Code Label</h2>
      <div class="label-container">
        <table class="data-table" id="dataTable"></table>
        <div id="qrcode"></div>
      </div>

      <button class="print-button" onclick="printAndReload()">
        Print Label
      </button>
    </div>

    <script>
      let hot;
      const FIELD_ORDER = [
        "HR Coil No.",
        "Batch No.",
        "Grade",
        "Heat No.",
        "Only Thickness",
        "Finish",
        "Edge Condition",
        "Quality",
        "QA Inspector",
        "Work Center",
        "Sample Location",
        "Remarks"
      ];

      function initHandsontable() {
        const container = document.getElementById("handsontable");
        hot = new Handsontable(container, {
          data: FIELD_ORDER.map((field) => [field, ""]),
          rowHeaders: false,
          colHeaders: ["Field Name", "Value"],
          manualColumnResize: true,
          manualRowResize: true,
          contextMenu: true,
          licenseKey: "non-commercial-and-evaluation"
        });

        hot.addHook("afterChange", function () {
          generateLabelFromHandsontable();
        });

        generateLabelFromHandsontable();
      }

      function generateLabelFromHandsontable() {
        let sheetData = hot.getData();
        let dataPairs = [];
        let qrValues = Array(FIELD_ORDER.length).fill(""); // Ensures all fields exist and are empty by default

        for (let i = 0; i < FIELD_ORDER.length; i++) {
          let fieldLabel = sheetData[i][0]?.trim();
          let fieldValue = sheetData[i][1]?.trim() || ""; // Maintain empty values for QR

          if (fieldLabel) {
            dataPairs.push([fieldLabel, fieldValue || "-"]);
          }

          qrValues[i] = fieldValue; // Maintain order and empty values
        }

        let table = document.getElementById("dataTable");
        table.innerHTML = "";
        dataPairs.forEach((row) => {
          let tr = document.createElement("tr");
          let td1 = document.createElement("td");
          let td2 = document.createElement("td");

          td1.textContent = row[0];
          td2.textContent = row[1];

          tr.appendChild(td1);
          tr.appendChild(td2);
          table.appendChild(tr);
        });

        // ✅ Ensure QR code format is strict with exactly 11 hash separators
        let qrText = qrValues.join("#");

        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
          text: qrText,
          width: 50,
          height: 50,
          correctLevel: QRCode.CorrectLevel.H
        });
      }

      function printAndReload() {
        window.print();
      }

      // ✅ Ensures page reloads **after** printing is completed
      window.onafterprint = function () {
        location.reload();
      };

      initHandsontable();
    </script>
  </body>
</html>
